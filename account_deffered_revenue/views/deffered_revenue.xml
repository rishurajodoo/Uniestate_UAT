<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record model="ir.ui.view" id="view_account_deffered_revenue_tree">
        <field name="name">deffered.revenue.tree</field>
        <field name="model">deffered.revenue</field>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <tree>
                <field name="name"/>
                <field name="first_depreciation_date" string=""/>
                <field name="book_value"/>
                <field name="value_residual"/>
            </tree>
        </field>
    </record>

    <record model="ir.ui.view" id="view_account_deffered_revenue_form">
        <field name="name">deffered.revenue.form</field>
        <field name="model">deffered.revenue</field>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="action_validate" string="Confirm" type="object" invisible="state != 'draft'"/>
                    <button name="compute_depreciation_board" type="object" string="Compute Revenue"/>
                    <button name="action_close" type="object" string="Close"  confirm="Do you want to close corresponding deferred revenue?"/>
<!--                    <button name="close_and_credit_note" type="object" string="Close and Credit Note"-->
<!--                            invisible="is_closed == False"/>-->
                    <field name="state" widget="statusbar" statusbar_visible="draft,open"/>
                </header>
                <sheet>
                    <div name="button_box" class="oe_button_box">
                        <button class="oe_stat_button" name="open_entries" string="Posted Entries"
                                invisible="not is_differed" type="object" icon="fa-bars">
                            <field string="Posted Entries" name="depreciation_entries_count" widget="statinfo"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <label for="name" name="name_label"/>
                        <h1>
                            <field name="name" placeholder="e.g. Laptop iBook" required="1"/>
                        </h1>
                    </div>
                    <group>
                        <group string="Property">
                            <field name="project_id"/>
                            <field name="building_id"/>
                            <field name="floor_id"/>
                            <field name="unit_id" widget="many2many_tags"/>
                            <field name="order_id"/>
                            <field name="is_closed" invisible="1"/>
                        </group>
                        <group string="Asset Values">
                            <field name="original_value"/>
                            <field name="acquisition_date"/>
                        </group>
                    </group>
                    <group>
                        <group string="Current Values">
                            <field name="value_residual"/>
                            <field name="book_value"/>
                        </group>
                        <group string="Deferred Revenue Method">
                            <label for="method_number" string="Number of Recognitions"/>
                            <div class="o_row">
                                <field name="method_number" required="1"/>
                                <field name="method_period" required="1" nolabel="1" readonly="1"/>
                            </div>
                            <field name="first_depreciation_date"/>
                        </group>
                    </group>
                    <group>
                        <group string="Accounting">
                            <field name="account_depreciation_id"/>
                            <field name="account_depreciation_expense_id"/>
                            <field name="journal_id"/>
                            <field name="is_differed" invisible="1"/>
                            <!--                            <field name="account_analytic_id"/>-->
                            <field name="analytic_distribution" widget="analytic_distribution"/>
                        </group>
                        <group string="Existing Defer Schedule" groups="base.group_no_one">
                            <field name="already_depreciated_amount_import" string="Deferred Amount"/>
                            <field name="depreciation_number_import" string="Existing Defer"/>
                            <field name="first_depreciation_date_import" string="First Defer Date"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Defer Board" name="depreciation_board">
                            <field name="depreciation_move_ids" mode="tree" options="{'reload_whole_on_button': true}"
                                   readonly="state not in ['draft', 'open']">
                                <tree string="Deferred Lines" decoration-info="state == 'draft'" create="0"
                                      default_order="date asc, id asc" editable="top">
                                    <field name="currency_id" column_invisible="True"
                                           readonly="state in ['cancel', 'posted']"/>
                                    <field name="ref" invisible="0"/>
                                    <field name="date" readonly="state in ['cancel', 'posted']" string="Deferred Date"/>
                                    <field name="reversal_move_id" widget="deprec_lines_reversed"/>
                                    <field name="differed_depreciation_value" readonly='1' widget="monetary"
                                           string="Amount" options="{'currency_field': 'currency_id'}"/>
                                    <field name="differed_depreciated_value" readonly='1' force_save="1"
                                           options="{'currency_field': 'currency_id'}"
                                           string="Cumalative Deferred Revenue"/>
                                    <field name="differed_remaining_value" readonly='1' widget="monetary" force_save="1"
                                           options="{'currency_field': 'currency_id'}" string="Remaining Defer Value"/>
                                    <field name="name" readonly="1" string="Journal Entry"/>
                                    <field name="state" column_invisible="True"/>
                                </tree>
                            </field>
                        </page>
                        <page string="Invoices" name="other_information">
                            <field name="invoice_ids">
                                <tree>
                                    <field name="reference"/>
                                    <field name="invoice_partner_display_name"
                                           column_invisible="context.get('default_move_type') not in ('in_invoice', 'in_refund', 'in_receipt')"
                                           groups="base.group_user" string="Vendor"/>
                                    <field name="invoice_partner_display_name"
                                           column_invisible="context.get('default_move_type') not in ('out_invoice', 'out_refund', 'out_receipt')"
                                           groups="base.group_user" string="Customer"/>
                                    <field name="invoice_date" optional="show"
                                           column_invisible="context.get('default_move_type') not in ('in_invoice', 'in_refund', 'in_receipt')"
                                           readonly="state != 'draft'" string="Bill Date"/>
                                    <field name="invoice_date" optional="show"
                                           column_invisible="context.get('default_move_type') not in ('out_invoice', 'out_refund', 'out_receipt')"
                                           readonly="state != 'draft'" string="Invoice Date"/>
                                    <field name="date" optional="hide" string="Accounting Date"
                                           readonly="state in ['cancel', 'posted']"/>
                                    <field name="invoice_date_due" widget="remaining_days" optional="show"
                                           invisible="payment_state in ('paid', 'in_payment', 'reversed') or state == 'cancel'"/>
                                    <field name="invoice_origin" optional="hide" string="Source Document"/>
                                    <field name="payment_reference" optional="hide"
                                           column_invisible="context.get('default_move_type') in ('out_invoice', 'out_refund', 'out_receipt')"/>
                                    <field name="ref" optional="hide"/>
                                    <field name="invoice_user_id" optional="hide"
                                           column_invisible="context.get('default_move_type') not in ('out_invoice', 'out_refund', 'out_receipt')"
                                           string="Salesperson" widget="many2one_avatar_user"/>
                                    <field name="activity_ids" widget="list_activity" optional="show"/>
                                    <field name="company_id" groups="base.group_multi_company"
                                           options="{'no_create': True}"
                                           optional="hide"/>
                                    <field name="company_id" groups="!base.group_multi_company"
                                           column_invisible="True"/>
                                    <field name="amount_untaxed_signed" string="Tax Excluded" sum="Total"
                                           optional="show"/>
                                    <field name="amount_tax_signed" string="Tax" sum="Total" optional="hide"/>
                                    <field name="amount_total_signed" string="Total" sum="Total" decoration-bf="1"
                                           optional="show"/>
                                    <field name="amount_total_in_currency_signed" string="Total in Currency"
                                           optional="show"
                                           groups="base.group_multi_currency"/>
                                    <field name="amount_total_in_currency_signed" string="Total in Currency"
                                           optional="hide"
                                           groups="!base.group_multi_currency"/>
                                    <field name="amount_residual_signed" string="Amount Due" sum="Amount Due"
                                           optional="hide"/>
                                    <field name="currency_id" optional="hide" readonly="state in ['cancel', 'posted']"/>
                                    <field name="company_currency_id" column_invisible="True"/>
                                    <field name="to_check" optional="hide" widget="boolean_toggle"/>
                                    <field name="payment_state" string="Payment" widget="badge"
                                           decoration-danger="payment_state == 'not_paid'"
                                           decoration-warning="payment_state in ('partial', 'in_payment')"
                                           decoration-success="payment_state in ('paid', 'reversed')"
                                           invisible="payment_state == 'invoicing_legacy' or state != 'posted' or move_type == 'entry'"
                                           optional="show"/>
                                    <field name="state" widget="badge" decoration-success="state == 'posted'"
                                           decoration-info="state == 'draft'" optional="show"/>
                                    <field name="move_type" column_invisible="context.get('default_move_type', True)"/>
                                    <!--                                <field name=""-->
                                </tree>
                            </field>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Deferred Revenues Action -->

    <record model="ir.actions.act_window" id="action_account_deffered_revenue_form">
        <field name="name">Deferred Revenues</field>
        <field name="res_model">deffered.revenue</field>
        <field name="view_ids" eval="[(5, 0, 0),
            (0, 0, {'view_mode': 'tree', 'view_id': ref('view_account_deffered_revenue_tree')}),
            (0, 0, {'view_mode': 'form', 'view_id': ref('view_account_deffered_revenue_form')})]"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create new deferred revenue
            </p>
        </field>
    </record>

    <menuitem parent="account.menu_finance_entries_management" id="menu_action_account_deffered_revenue"
              action="action_account_deffered_revenue_form" sequence="103"/>
</odoo>
